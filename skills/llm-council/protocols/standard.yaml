# LLM Council - Standard Protocol v4.1
# Multi-LLM deliberation with cross-evaluation

version: "4.1"
metadata:
  name: standard-council
  description: |
    Multi-LLM deliberation protocol with mandatory cross-evaluation.
    Dynamically discovers available LLMs - no predefined roles.

# ============================================================
# PREREQUISITES
# ============================================================

prerequisites:
  external_llm_required: true
  min_participants: 2
  discovery: dynamic
  description: |
    Discovers available LLM tools at runtime.
    All participants are equal - no predefined roles.

# ============================================================
# LLM DISCOVERY
# ============================================================

discovery:
  method: dynamic
  patterns:
    - "mcp__*__ask-*"
    - "mcp__*__query"
    - "mcp__*__chat"
  on_none_found: abort

# ============================================================
# EXECUTION MODES
# ============================================================

execution_modes:
  mode_a:
    name: "Multi-Agent"
    description: |
      Spawn parallel sub-agents for external LLM calls.
      Host answers directly, agents call external LLMs.
    requirements:
      - sub_agent_support
      - external_llm_access
    execution: parallel_agents
    agent_count: "external_llm_count"
    recommended: true

  mode_b:
    name: "Parallel Tools"
    description: |
      Parallel tool calls in single context.
    requirements:
      - external_llm_access
    execution: parallel_tools
    agent_count: 0

# ============================================================
# CROSS-EVALUATION
# ============================================================

cross_evaluation:
  mandatory: true
  self_evaluation: false
  scores_per_response: "N - 1"
  agent_count: "external_llm_count"

  anonymization:
    shuffle_order: true
    relabel_responses: true
    strip_metadata: true
    record_mapping: true
    reveal_timing: after_all_scores

# ============================================================
# ROLES
# ============================================================

roles:
  participant:
    description: Provides independent response
    assignment: dynamic
    min_count: 2

  evaluator:
    description: Evaluates OTHER participants' responses only
    assignment: all_participants
    evaluates: others_only

  chairman:
    description: Synthesizes final answer
    count: 1
    assignment: host

# ============================================================
# FLOW
# ============================================================

flow:
  stages:
    - id: discover
      name: "Step 0: Discover Available LLMs"
      type: discovery
      config:
        method: dynamic
        on_none_found: abort

    - id: collect
      name: "Stage 1: Collect Independent Responses"
      type: collect
      config:
        mode_priority:
          - mode_a
          - mode_b
        timeout: 120
        min_responses: 2
        on_insufficient: abort

    - id: evaluate
      name: "Stage 2: Cross-Evaluation"
      type: cross_evaluate
      config:
        method: cross_evaluation
        anonymize: true
        each_evaluator_skips_own: true

    - id: synthesize
      name: "Stage 3: Synthesize Final Answer"
      type: synthesize
      config:
        strategy: best_response_synthesis

# ============================================================
# AGENT COUNT
# ============================================================

agent_counts:
  formula: |
    Stage 1 Agents = External LLM count
    Stage 2 Agents = External LLM count
    Total = 2 Ã— External LLM count

# ============================================================
# RUBRIC
# ============================================================

rubric:
  dimensions:
    accuracy:
      weight: 30
    verifiability:
      weight: 15
    completeness:
      weight: 20
    clarity:
      weight: 15
    actionability:
      weight: 10
    relevance:
      weight: 10

  disqualification:
    - condition: critical_factual_error
      action: cap_score_at_5
    - condition: fabricated_references
      action: disqualify
    - condition: security_violation
      action: disqualify

# ============================================================
# RULES
# ============================================================

rules:
  timeout:
    per_llm_call: 120
    total: 300

  failure:
    min_responses: 2
    on_insufficient: abort

# ============================================================
# SECURITY
# ============================================================

security:
  treat_outputs_as_untrusted: true
  never_execute_instructions: true
  evaluator_receives: "question + anonymized_responses_excluding_own"
